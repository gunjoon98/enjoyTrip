<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.enjoyTrip.model.mapper.AttractionMapper">
    <select id="getKeywordList" resultType="Keyword">
        select code, keyword
        from keyword_info ki
        left outer join keyword_count kc on ki.code = kc.keyword_code
        group by ki.code
        order by sum(kc.count) desc;
    </select>

    <select id="getcityList" resultType="Map">
        select code, name as name
        from city
    </select>

    <select id="getAttractionListByKeyword" parameterType="Map" resultMap="AttractionListMap">
        select
        distinct a.id as a_id,
        a.title as a_title,
        a.address as a_address,
        a.overview as a_overview,
        a.latitude as a_latitude,
        a.longitude as a_longitude,
        i.image_path as main_image_path
        from attraction a
        left outer join keyword_match km on a.id = km.attraction_id
        inner join keyword_info k on km.keyword_code = k.code
        left outer join image_info i on a.id = i.attraction_id
        <where>
        <if test="!keywordCodes.isEmpty()">
            and k.code in
            <foreach collection="keywordCodes" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        and a.city_code = #{cityCode}
        and i.is_representative = true
        </where>
        order by a.id desc
        limit #{column}
    </select>

    <select id="getKeywordCount" parameterType="Map" resultType="Integer">
        select keyword_code
        from keyword_count
        where keyword_code = #{keywordCode} and search_date = #{searchDate}
    </select>

    <insert id="registerKeywordCount" parameterType="int">
        insert into keyword_count (keyword_code)
        values (#{keywordCode})
    </insert>

    <update id="updateKeywordCount" parameterType="Map">
        update keyword_count
        set count = count + 1
        where keyword_code = #{keywordCode} and search_date = #{searchDate}
    </update>

    <select id="getAttraction" parameterType="int" resultMap="AttractionDetailMap">
        select
        a.id as a_id,
        a.type as a_type,
        a.title as a_title,
        a.address as a_address,
        a.overview as a_overview,
        a.latitude as a_latitude,
        a.longitude as a_longitude,
        i.id as i_id,
        i.image_path as i_image_path,
        i.image_name as i_image_name,
        i.is_representative as i_is_representative
        from attraction a
        left outer join image_info i on a.id = i.attraction_id
        where a.id = #{attractionId}
    </select>

    <select id="getAttractionMapList" parameterType="Map" resultMap="AttractionMap">
        select
        a.id as a_id,
        a.type as a_type,
        a.title as a_title,
        a.address as a_address,
        a.overview as a_overview,
        a.latitude as a_latitude,
        a.longitude as a_longitude,
        i.image_path as i_image_path
        from attraction a
        left outer join image_info i on a.id = i.attraction_id
        where i.is_representative = true
        and a.type = #{type}
        and a.city_code = #{cityCode}
        and a.id != #{exceptId}
        <if test="title.length() != 0">
            and a.title like CONCAT('%', #{title}, '%')
        </if>
        limit #{start}, #{sizePerPage}
    </select>

    <select id="getAttractionMapListByUser" parameterType="Map" resultMap="AttractionListByUserMap">
        select
        a.id as a_id,
        a.type as a_type,
        a.title as a_title,
        a.address as a_address,
        a.overview as a_overview,
        a.latitude as a_latitude,
        a.longitude as a_longitude,
        i.image_path as i_image_path,
        if(ia.user_id=#{userId}, true, false) as interest
        from attraction a
        left outer join image_info i on a.id = i.attraction_id
        left outer join interest_attraction ia on a.id = ia.attraction_id
        where i.is_representative = true
        and a.type = #{type}
        and a.city_code = #{cityCode}
        and a.id != #{exceptId}
        <if test="title.length() != 0">
            and a.title like CONCAT('%', #{title}, '%')
        </if>
        limit #{start}, #{sizePerPage}
    </select>

    <select id="getInterest" parameterType="Map" resultType="String">
        select user_id
        from interest_attraction
        where user_id=#{userId} and attraction_id=#{attractionId}
    </select>

    <insert id="registerInterest" parameterType="Map">
        insert into interest_attraction (user_id, attraction_id)
        values (#{userId}, #{attractionId})
    </insert>

    <delete id="deleteInterest" parameterType="Map">
        delete from interest_attraction
        where user_id = #{userId} and attraction_id = #{attractionId}
    </delete>

    <select id="getInterestList" parameterType="String" resultMap="InterestListMap">
        select
        a.id as a_id,
        a.type as a_type,
        a.title as a_title,
        a.address as a_address,
        a.overview as a_overview,
        i.image_path as i_image_path
        from interest_attraction ia
        inner join attraction a on ia.attraction_id = a.id
        left outer join image_info i on a.id = i.attraction_id
        where i.is_representative = true and ia.user_id = #{userId}
    </select>

    <resultMap id="AttractionListMap" type="Attraction">
        <id column="a_id" property="id"/>
        <result column="a_title" property="title"/>
        <result column="a_address" property="address"/>
        <result column="a_overview" property="overview"/>
        <result column="a_latitude" property="latitude"/>
        <result column="a_longitude" property="longitude"/>
        <result column="main_image_path" property="mainImagePath"/>
    </resultMap>

    <resultMap id="AttractionDetailMap" type="Attraction">
        <id column="a_id" property="id"/>
        <result column="a_type" property="type"/>
        <result column="a_title" property="title"/>
        <result column="a_address" property="address"/>
        <result column="a_overview" property="overview"/>
        <result column="a_latitude" property="latitude"/>
        <result column="a_longitude" property="longitude"/>
        <collection property="imageInfos" ofType="ImageInfo" javaType="List">
            <id column="i_id" property="id"/>
            <result column="i_image_path" property="imagePath"/>
            <result column="i_image_name" property="imageName"/>
            <result column="i_is_representative" property="representative"/>
        </collection>
    </resultMap>

    <resultMap id="AttractionMap" type="Attraction">
        <id column="a_id" property="id"/>
        <result column="a_type" property="type"/>
        <result column="a_title" property="title"/>
        <result column="a_address" property="address"/>
        <result column="a_overview" property="overview"/>
        <result column="a_latitude" property="latitude"/>
        <result column="a_longitude" property="longitude"/>
        <result column="i_image_path" property="mainImagePath"/>
    </resultMap>

    <resultMap id="AttractionListByUserMap" type="Attraction">
        <id column="a_id" property="id"/>
        <result column="a_type" property="type"/>
        <result column="a_title" property="title"/>
        <result column="a_address" property="address"/>
        <result column="a_overview" property="overview"/>
        <result column="a_latitude" property="latitude"/>
        <result column="a_longitude" property="longitude"/>
        <result column="i_image_path" property="mainImagePath"/>
        <result column="interest" property="interest"/>
    </resultMap>

    <resultMap id="InterestListMap" type="Attraction">
        <id column="a_id" property="id"/>
        <result column="a_type" property="type"/>
        <result column="a_title" property="title"/>
        <result column="a_address" property="address"/>
        <result column="a_overview" property="overview"/>
        <result column="i_image_path" property="mainImagePath"/>
    </resultMap>
</mapper>
