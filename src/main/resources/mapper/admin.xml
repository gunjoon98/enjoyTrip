<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.enjoyTrip.model.mapper.AdminMapper">
    <select id="getAttraction" parameterType="int" resultMap="AttractionMap">
        select
        a.id as a_id,
        a.type as a_type,
        a.title as a_title,
        a.address as a_address,
        a.city_code as a_city_code,
        a.overview as a_overview,
        a.latitude as a_latitude,
        a.longitude as a_longtitue,
        k.keyword as k_keyword,
        k.code as k_code,
        i.id as i_id,
        CONCAT('/', i.folder_name, '/', i.image_name) as image_path,
        i.original_image_name as i_original_image_name,
        i.is_representative as i_is_representative
        from attraction a
        left outer join keyword_match km on a.id = km.attraction_id
        inner join keyword_info k on km.keyword_code = k.code
        left outer join image_info i on a.id = i.attraction_id
        where a.id = #{attractionId}
    </select>

    <select id="getAttractionList" parameterType="Map" resultMap="AttractionListMap">
        select
        a.id as a_id,
        a.title as a_title,
        a.address as a_address,
        a.overview as a_overview,
        CONCAT('/', i.folder_name, '/', i.image_name) as main_image_path
        from attraction a
        left outer join image_info i on a.id = i.attraction_id
        <where>
        <if test="title != null">
            and a.title like CONCAT('%', #{title}, '%')
        </if>
        <if test="cityCode != null">
            and a.city_code = #{cityCode}
        </if>
        and i.is_representative = true
        </where>
        order by a.id desc
        limit #{start}, #{sizePerPage}
    </select>

    <insert id="registerAttraction" parameterType="Attraction">
        insert into attraction (type, title, address, city_code, overview, latitude, longitude)
        values (#{type}, #{title}, #{address}, ${cityCode}, #{overview}, #{latitude}, #{longitude})
        <selectKey keyProperty="id" resultType="int" order="AFTER">
            select LAST_INSERT_ID()
        </selectKey>
    </insert>

    <insert id="registerKeywordMatch" parameterType="Attraction">
        insert into keyword_match (attraction_id, keyword_code)
        values
        <foreach collection="keywordCodes" item="item" separator=",">
            (#{id}, #{item})
        </foreach>
    </insert>

    <insert id="registerImageInfo" parameterType="list">
        insert into image_info (attraction_id, image_name, folder_name, original_image_name, is_representative)
        values
        <foreach collection="list" item="item" separator=",">
            (#{item.attractionId}, #{item.imageName}, #{item.folderName}, #{item.originalImageName}, #{item.representative})
        </foreach>
    </insert>

    <resultMap id="AttractionMap" type="Attraction">
        <id column="a_id" property="id"/>
        <result column="a_type" property="type"/>
        <result column="a_title" property="title"/>
        <result column="a_address" property="address"/>
        <result column="a_city_code" property="cityCode"/>
        <result column="a_overview" property="overview"/>
        <result column="a_latitude" property="latitude"/>
        <result column="a_longitude" property="longitude"/>
        <collection property="keywords" ofType="Keyword" javaType="List">
            <result column="k_keyword" property="keyword"/>
            <result column="k_code" property="code"/>
        </collection>
        <collection property="imageInfos" ofType="ImageInfo" javaType="List">
            <id column="i_id" property="id"/>
            <result column="image_path" property="imagePath"/>
            <result column="i_original_image_name" property="originalImageName"/>
            <result column="i_folder_name" property="folderName"/>
            <result column="i_is_representative" property="representative"/>
        </collection>
    </resultMap>

    <resultMap id="AttractionListMap" type="Attraction">
        <id column="a_id" property="id"/>
        <result column="a_title" property="title"/>
        <result column="a_address" property="address"/>
        <result column="a_overview" property="overview"/>
        <result column="main_image_path" property="mainImagePath"/>
    </resultMap>
</mapper>